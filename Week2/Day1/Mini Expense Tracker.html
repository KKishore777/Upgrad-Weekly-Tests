<!DOCTYPE html>
<html>
<head>
    <title>Expense Tracker - IndexedDB + Fake API</title>

</head>
<body>

<h2>Expense Tracker</h2>

<input type="text" id="title" placeholder="Expense Title">
<input type="number" id="amount" placeholder="Amount">
<input type="date" id="date">

<br>

<button onclick="addExpense()">Add Expense</button>
<button onclick="viewExpenses()">View Expenses</button>

<table>
    <thead>
        <tr>
            <th>Title</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="expenseList"></tbody>
</table>

<script>
let db;

// Open Database
let request = indexedDB.open("ExpenseDB", 1);

request.onupgradeneeded = function(event) {
    db = event.target.result;
    let store = db.createObjectStore("expenses", { keyPath: "id", autoIncrement: true });
    store.createIndex("title", "title", { unique: false });
};

request.onsuccess = function(event) {
    db = event.target.result;
    viewExpenses();
};

request.onerror = function(event) {
    console.error("DB Error:", event.target.error);
};

// ADD EXPENSE (Fake API + IndexedDB)
async function addExpense() {

    let title = document.getElementById("title").value;
    let amount = document.getElementById("amount").value;
    let date = document.getElementById("date").value;

    if (!title || !amount || !date) {
        alert("Fill all fields");
        return;
    }

    let expenseData = { title, amount, date };

    try {
        // Send to Fake API
        let response = await fetch("https://jsonplaceholder.typicode.com/posts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(expenseData)
        });

        if (!response.ok) throw new Error("API Insert Failed");

        let apiResult = await response.json();
        console.log("Fake API Response:", apiResult);

        //  Insert into IndexedDB after API success
        let transaction = db.transaction(["expenses"], "readwrite");

        transaction.onerror = function(event) {
            console.error("Transaction Error:", event.target.error);
        };

        let store = transaction.objectStore("expenses");
        let addRequest = store.add(expenseData);

        addRequest.onsuccess = function() {
            alert("Expense Added Successfully (API + IndexedDB)");
            viewExpenses();
        };

        addRequest.onerror = function(event) {
            console.error("Insert Error:", event.target.error);
        };

    } catch (error) {
        console.error("API Error:", error);
        alert("Failed to insert via Fake API");
    }
}

// VIEW
function viewExpenses() {

    let transaction = db.transaction(["expenses"], "readonly");
    let store = transaction.objectStore("expenses");

    let request = store.getAll();

    request.onsuccess = function(event) {
        let expenses = event.target.result;
        let output = "";

        expenses.forEach(exp => {
            output += `
                <tr>
                    <td>${exp.title}</td>
                    <td>${exp.amount}</td>
                    <td>${exp.date}</td>
                    <td>
                        <button onclick="deleteExpense(${exp.id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        });

        document.getElementById("expenseList").innerHTML = output;
    };

    request.onerror = function(event) {
        console.error("Select Error:", event.target.error);
    };
}

// DELETE
function deleteExpense(id) {

    let transaction = db.transaction(["expenses"], "readwrite");

    transaction.onerror = function(event) {
        console.error("Transaction Error:", event.target.error);
    };

    let store = transaction.objectStore("expenses");
    let deleteRequest = store.delete(id);

    deleteRequest.onsuccess = function() {
        alert("Deleted Successfully");
        viewExpenses();
    };

    deleteRequest.onerror = function(event) {
        console.error("Delete Error:", event.target.error);
    };
}
</script>

</body>
</html>